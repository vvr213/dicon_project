📖 ダイコンアプリ開発手順書（統合版）

目標: 商店街ECサイト（マルチベンダー型）の構築
構成:

設定フォルダ: config (分かりやすさ重視)

テンプレート: templates フォルダを一番外に置く (パターン3)

DB: ローカルはSQLite、本番はPostgreSQL（自動切り替え）

🛠 Step 1: プロジェクトの土台を作る

まずはコマンド操作で、プロジェクトの骨組みを作ります。

1. 仮想環境の準備

ターミナルで dicon_project フォルダの中にいる状態で実行します。

# 仮想環境作成
python3 -m venv venv

# 有効化 (Mac)
source venv/bin/activate
# (Windowsなら: .\venv\Scripts\activate)

# Djangoインストール
pip install django



2. プロジェクトとアプリの作成

ここで設定フォルダ名を config にします。これが一番管理しやすいです。

# プロジェクト作成 (末尾のドット . を忘れずに！)
django-admin startproject config .

# アプリの作成 (機能ごとに分ける)
python manage.py startapp users    # ユーザー・認証
python manage.py startapp vendors  # 店舗管理
python manage.py startapp products # 商品管理
python manage.py startapp cart     # カート機能
python manage.py startapp orders   # 注文管理（今回は枠だけ）



3. フォルダ構成の確認と修正

一番外側に templates フォルダと static フォルダを手動で作ります。
最終的に以下の構成になります。

dicon_project/
├── manage.py
├── config/             <-- 設定フォルダ
├── users/
├── vendors/
├── products/
├── cart/
├── orders/
├── templates/          <-- ★ここに全HTMLを入れる (重要！)
│   ├── base.html
│   ├── index.html
│   └── ...
└── static/             <-- CSSや画像置き場



💡 コラム：なぜ学校のやり方（アプリごとのテンプレート）じゃないの？

学校のやり方 (users/templates/users/...)

メリット: そのアプリ単体で「部品」として完成する。他のプロジェクトに users フォルダごとコピーすれば、そのまま使える（再利用性が高い）。

デメリット: 全体のデザインを統一したい時、あちこちのフォルダを開いて回るのが大変。

向いている時: 誰かに配布するライブラリを作る時。

今回のやり方 (templates/...)

メリット: すべてのHTMLが一箇所にあるので、「デザインを変えたい！」と思った時に探しやすい。base.html（共通デザイン）の管理も楽。

デメリット: アプリ単体を切り離して再利用しにくい。

向いている時: 今回のような、一つのWebサービスとして完結するものを作る時。

⚙️ Step 2: 設定ファイル (settings.py) の編集

config/settings.py を開き、以下の3箇所を修正します。

1. アプリの登録

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    
    # ▼ 作成したアプリを追加
    'users.apps.UsersConfig',
    'vendors.apps.VendorsConfig',
    'products.apps.ProductsConfig',
    'cart.apps.CartConfig',
    'orders.apps.OrdersConfig',
]



2. 認証ユーザーモデルの指定（最下部に追加）

Django標準のユーザーではなく、カスタマイズしたユーザーを使う設定です。

AUTH_USER_MODEL = 'users.CustomUser'



3. テンプレート場所の指定（TEMPLATES設定の修正）

「HTMLは一番外のフォルダにあるよ」と教えてあげます。

import os # ファイルの先頭に追加

TEMPLATES = [
    {
        # ...
        'DIRS': [BASE_DIR / 'templates'],  # ★ここを修正
        'APP_DIRS': True,
        # ...
    },
]

# ついでに言語設定なども
LANGUAGE_CODE = 'ja'
TIME_ZONE = 'Asia/Tokyo'



📝 Step 3: モデル（データの設計図）を作る

各アプリの models.py にコードを記述します。

1. users/models.py (ユーザー情報)

お気に入り機能もここで紐付けます。

from django.contrib.auth.models import AbstractUser
from django.db import models

class CustomUser(AbstractUser):
    # 追加フィールド
    address = models.CharField("住所", max_length=255, blank=True, null=True)
    phone_number = models.CharField("電話番号", max_length=20, blank=True, null=True)
    
    # お気に入り商品（多対多の関係）
    # 'products.Product' と文字列で書くことで読み込み順のエラーを防ぐ
    favorite_products = models.ManyToManyField(
        'products.Product', 
        related_name='favorited_by', 
        blank=True,
        verbose_name="お気に入り商品"
    )



2. vendors/models.py (店舗情報)

from django.db import models

class Vendor(models.Model):
    name = models.CharField("店舗名", max_length=100)
    description = models.TextField("店舗説明", blank=True)
    # 店長ユーザーを紐付けるならここにOneToOneFieldなどを追加

    def __str__(self):
        return self.name



3. products/models.py (商品情報)

from django.db import models
from vendors.models import Vendor

class Category(models.Model):
    name = models.CharField("カテゴリ名", max_length=100)
    def __str__(self): return self.name

class Product(models.Model):
    vendor = models.ForeignKey(Vendor, on_delete=models.CASCADE, related_name='products')
    category = models.ForeignKey(Category, on_delete=models.SET_NULL, null=True, blank=True)
    name = models.CharField("商品名", max_length=200)
    price = models.PositiveIntegerField("価格")
    description = models.TextField("説明")
    image = models.ImageField(upload_to='products/', blank=True, null=True)
    available = models.BooleanField("販売中", default=True)
    created_at = models.DateTimeField(auto_now_add=True)

    def __str__(self): return self.name



4. cart/models.py (カート機能)

from django.db import models
from django.conf import settings
from products.models import Product

class Cart(models.Model):
    # ログインユーザー用
    user = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.CASCADE, null=True, blank=True)
    # 未ログインユーザー用
    session_key = models.CharField(max_length=40, null=True, blank=True)
    created_at = models.DateTimeField(auto_now_add=True)

    @property
    def total_price(self):
        return sum(item.total_cost for item in self.items.all())

class CartItem(models.Model):
    cart = models.ForeignKey(Cart, related_name='items', on_delete=models.CASCADE)
    product = models.ForeignKey(Product, on_delete=models.CASCADE)
    quantity = models.PositiveIntegerField(default=1)

    @property
    def total_cost(self):
        return self.product.price * self.quantity



🗂 Step 4: データベースへの反映

モデルを書いたら、必ずこのコマンドを実行します。

# マイグレーションファイルの作成
python manage.py makemigrations

# データベースに適用
python manage.py migrate

# 管理者ユーザーの作成（管理画面に入るため）
python manage.py createsuperuser



🔗 Step 5: URLとビューの作成

1. 全体のルーティング (config/urls.py)

from django.contrib import admin
from django.urls import path, include
from django.conf import settings
from django.conf.urls.static import static

urlpatterns = [
    path('admin/', admin.site.urls),
    path('cart/', include('cart.urls')),       # カート
    path('products/', include('products.urls')), # 商品
    path('users/', include('users.urls')),     # ユーザー
    # トップページなどはここで定義するか、productsアプリに任せる
]

# 画像表示用設定
if settings.DEBUG:
    urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)



2. カート機能のロジック (cart/views.py)

from django.shortcuts import redirect, get_object_or_404, render
from products.models import Product
from .models import Cart, CartItem

# カート取得の便利関数
def _get_cart(request):
    if request.user.is_authenticated:
        cart, _ = Cart.objects.get_or_create(user=request.user)
    else:
        # セッションキーがない場合は作成
        if not request.session.session_key:
            request.session.create()
        cart, _ = Cart.objects.get_or_create(session_key=request.session.session_key)
    return cart

def add_to_cart(request, product_id):
    product = get_object_or_404(Product, id=product_id)
    cart = _get_cart(request)
    
    cart_item, created = CartItem.objects.get_or_create(cart=cart, product=product)
    if not created:
        cart_item.quantity += 1
        cart_item.save()
    
    return redirect('cart:detail')

def cart_detail(request):
    cart = _get_cart(request)
    return render(request, 'cart/detail.html', {'cart': cart})



🎨 Step 6: テンプレートの作成

templates フォルダの中にHTMLを作っていきます。

1. templates/base.html (共通デザイン)

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ダイコン商店街</title>
</head>
<body>
    <header>
        <nav>
            <a href="/">ホーム</a>
            <a href="{% url 'cart:detail' %}">カート</a>
            {% if user.is_authenticated %}
                <a href="{% url 'users:dashboard' %}">マイページ</a>
                <a href="{% url 'users:logout' %}">ログアウト</a>
            {% else %}
                <a href="{% url 'users:login' %}">ログイン</a>
            {% endif %}
        </nav>
    </header>
    
    <main>
        {% block content %}
        {% endblock %}
    </main>
</body>
</html>



2. templates/cart/detail.html (カート画面)

{% extends 'base.html' %}

{% block content %}
<h1>ショッピングカート</h1>
<ul>
    {% for item in cart.items.all %}
    <li>
        {{ item.product.name }} - {{ item.quantity }}個
        (¥{{ item.total_cost }})
    </li>
    {% endfor %}
</ul>
<p>合計: ¥{{ cart.total_price }}</p>
<button>レジへ進む</button>
{% endblock %}



🚀 完了！

これで、商店街アプリの「骨格」と「主要機能（カート・ユーザー・商品）」のベースが完成しました。

あとは python manage.py runserver で動かしながら、少しずつ機能を追加していくだけです！