{% extends "base.html" %}
{% load static %}

{% block title %}おせっかい相談チャット{% endblock %}

{% block content %}

<div class="sticky-top bg-white border-bottom shadow-sm py-2 px-3 mb-3 d-flex align-items-center justify-content-between" style="top: 56px; z-index: 100;">
    <div class="d-flex align-items-center">
      
      <a href="{% url 'dicon_app:consult_menu' %}" class="btn btn-outline-secondary btn-sm rounded-pill fw-bold me-3 px-3 shadow-sm" style="font-size: 0.8rem;">
        <i class="fa-solid fa-arrow-left me-1"></i>戻る
      </a>
      
      <div class="position-relative">
        <div class="bg-danger rounded-circle d-flex align-items-center justify-content-center text-white fw-bold" style="width: 40px; height: 40px; font-size: 1.2rem;">
          <i class="fa-solid fa-user-tie"></i>
        </div>
        <span class="position-absolute bottom-0 end-0 bg-success border border-white rounded-circle" style="width: 10px; height: 10px;"></span>
      </div>
      <div class="ms-3">
        <h6 class="fw-bold m-0" style="font-size: 0.9rem;">商店街コンシェルジュ</h6>
        <small class="text-success" style="font-size: 0.75rem;"><i class="fa-solid fa-circle me-1"></i>オンライン</small>
      </div>
    </div>
    <a href="tel:000-0000-0000" class="btn btn-light rounded-circle text-success btn-sm p-2"><i class="fa-solid fa-phone"></i></a>
  </div>

<div class="container pb-5 mb-5" style="max-width: 800px;">
  
  <div class="text-center my-4">
    <span class="badge bg-secondary bg-opacity-25 text-dark fw-normal px-3 rounded-pill">今日 18:30</span>
  </div>

  <div class="d-flex align-items-end mb-4">
    <div class="flex-shrink-0 me-2">
      <div class="bg-danger rounded-circle d-flex align-items-center justify-content-center text-white small" style="width: 40px; height: 40px;">
        <i class="fa-solid fa-user-tie"></i>
      </div>
    </div>
    <div class="bg-white p-3 rounded-4 rounded-bottom-0 shadow-sm border" style="max-width: 75%; border-bottom-left-radius: 4px !important;">
      <p class="mb-0">いらっしゃい！今日は何にする？<br>晩ごはんの献立でも、下処理だけでも何でも言うてや〜。</p>
    </div>
    <small class="text-muted ms-2 mb-1" style="font-size: 0.7rem;">18:30</small>
  </div>

  {% if preset_title %}
  <div class="d-flex align-items-end justify-content-end mb-4">
    <small class="text-muted me-2 mb-1" style="font-size: 0.7rem;">18:31 既読</small>
    <div class="bg-danger text-white p-3 rounded-4 rounded-bottom-0 shadow-sm" style="max-width: 75%; border-bottom-right-radius: 4px !important;">
      <p class="mb-0 fw-bold">相談：{{ preset_title }}</p>
      <p class="mb-0 small opacity-75 mt-1">{{ preset_desc }}</p>
    </div>
  </div>

  <div class="d-flex align-items-end mb-4">
    <div class="flex-shrink-0 me-2">
      <div class="bg-danger rounded-circle d-flex align-items-center justify-content-center text-white small" style="width: 40px; height: 40px;">
        <i class="fa-solid fa-user-tie"></i>
      </div>
    </div>
    <div class="bg-white p-3 rounded-4 rounded-bottom-0 shadow-sm border" style="max-width: 75%; border-bottom-left-radius: 4px !important;">
      <p class="mb-0">
        了解！<span class="fw-bold text-danger">{{ preset_title }}</span> やね。<br>
        任しとき！<br>
        <br>
        ちなみに人数は何人くらい？<br>
        あと、苦手な野菜とかアレルギーあったら今のうちに言うてね。
      </p>
    </div>
    <small class="text-muted ms-2 mb-1" style="font-size: 0.7rem;">18:31</small>
  </div>
  {% endif %}

</div>

<div class="fixed-bottom bg-white border-top p-3 shadow-lg">
  <div class="container" style="max-width: 800px;">
    <div class="d-flex gap-3 mb-2 px-2 text-secondary">
      <i class="fa-solid fa-camera fa-lg cursor-pointer"></i>
      <i class="fa-solid fa-image fa-lg cursor-pointer"></i>
      <i class="fa-solid fa-microphone fa-lg cursor-pointer"></i>
    </div>
    
    <form class="d-flex gap-2">
      <input type="text" class="form-control rounded-pill bg-light border-0 py-2 px-4" placeholder="メッセージを入力（例：大人2人と子供1人です）">
      <button type="button" class="btn btn-danger rounded-circle d-flex align-items-center justify-content-center shadow" style="width: 45px; height: 45px;">
        <i class="fa-solid fa-paper-plane"></i>
      </button>
    </form>
  </div>
</div>

<style>
/* ★重要：このページだけ共通フッターを隠す設定 */
footer {
  display: none !important;
}

/* タイピングアニメーション */
.typing-indicator span {
  display: inline-block; width: 6px; height: 6px; background-color: #ccc; border-radius: 50%;
  animation: typing 1.4s infinite ease-in-out both; margin: 0 1px;
}
.typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
.typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
@keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

.cursor-pointer { cursor: pointer; transition: color 0.2s; }
.cursor-pointer:hover { color: #dc3545; }

.hover-bg-light:hover { background-color: #f8f9fa; }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
      const input = document.querySelector('input[type="text"]');
      const sendBtn = document.querySelector('.btn-danger'); // 送信ボタン
      const chatContainer = document.querySelector('.container.pb-5'); // チャット表示エリア
    
      // メッセージを追加する関数
      function addMessage(text) {
        // 1. 自分のメッセージを表示
        const myMsgHTML = `
          <div class="d-flex align-items-end justify-content-end mb-4 fade-in">
            <small class="text-muted me-2 mb-1" style="font-size: 0.7rem;">今</small>
            <div class="bg-danger text-white p-3 rounded-4 rounded-bottom-0 shadow-sm" style="max-width: 75%; border-bottom-right-radius: 4px !important;">
              <p class="mb-0">${text}</p>
            </div>
          </div>
        `;
        chatContainer.insertAdjacentHTML('beforeend', myMsgHTML);
        window.scrollTo(0, document.body.scrollHeight); // 一番下までスクロール
    
        // 2. 入力欄をクリア
        input.value = '';
    
        // 3. おばちゃんの返信（2秒後）
        setTimeout(() => {
          // ローディング表示（...）
          const loadingHTML = `
            <div class="d-flex align-items-end mb-4 loading-msg fade-in">
              <div class="flex-shrink-0 me-2">
                <div class="bg-danger rounded-circle d-flex align-items-center justify-content-center text-white small" style="width: 40px; height: 40px;">
                  <i class="fa-solid fa-user-tie"></i>
                </div>
              </div>
              <div class="bg-light px-3 py-2 rounded-4 shadow-sm">
                 <div class="typing-indicator"><span></span><span></span><span></span></div>
              </div>
            </div>
          `;
          chatContainer.insertAdjacentHTML('beforeend', loadingHTML);
          window.scrollTo(0, document.body.scrollHeight);
    
          // さらに1.5秒後に返信を表示
          setTimeout(() => {
            // ローディングを消す
            document.querySelector('.loading-msg').remove();
    
            const replyHTML = `
              <div class="d-flex align-items-end mb-4 fade-in">
                <div class="flex-shrink-0 me-2">
                  <div class="bg-danger rounded-circle d-flex align-items-center justify-content-center text-white small" style="width: 40px; height: 40px;">
                    <i class="fa-solid fa-user-tie"></i>
                  </div>
                </div>
                <div class="bg-white p-3 rounded-4 rounded-bottom-0 shadow-sm border" style="max-width: 75%; border-bottom-left-radius: 4px !important;">
                  <p class="mb-0">了解！<br>ほな、その内容で準備しとくね。<br>ありがとう！</p>
                </div>
                <small class="text-muted ms-2 mb-1" style="font-size: 0.7rem;">今</small>
              </div>
            `;
            chatContainer.insertAdjacentHTML('beforeend', replyHTML);
            window.scrollTo(0, document.body.scrollHeight);
          }, 1500);
    
        }, 600);
      }
    
      // 送信ボタンクリック時
      sendBtn.addEventListener('click', function() {
        if (input.value.trim() !== '') {
          addMessage(input.value);
        }
      });
    
      // Enterキーでも送信
      input.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault(); // フォーム送信を防ぐ
          if (input.value.trim() !== '') {
            addMessage(input.value);
          }
        }
      });
    });
    </script>
    
    <style>
    /* ふわっと出るアニメーション */
    .fade-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>

{% endblock %}